#!/bin/bash

# Pre-commit hook to prevent committing sensitive information
# This file should be placed in .git/hooks/pre-commit

echo "ðŸ” Running pre-commit security checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check for .env files
if git diff --cached --name-only | grep -q "\.env$"; then
    echo -e "${RED}âŒ ERROR: Attempting to commit .env file!${NC}"
    echo -e "${YELLOW}Please remove .env from staging area:${NC}"
    echo -e "   git reset HEAD .env"
    exit 1
fi

# Check for common secret patterns in staged files
SECRETS_PATTERN='(password|secret|api[_-]?key|token|credential|private[_-]?key|access[_-]?key)'
if git diff --cached --name-only | xargs grep -iE "$SECRETS_PATTERN" 2>/dev/null | grep -v ".env.example" | grep -q .; then
    echo -e "${YELLOW}âš ï¸  WARNING: Possible secrets detected in staged files!${NC}"
    echo -e "${YELLOW}Please review the following matches:${NC}"
    git diff --cached --name-only | xargs grep -inE "$SECRETS_PATTERN" 2>/dev/null | grep -v ".env.example"
    echo ""
    echo -e "${YELLOW}If these are false positives, you can proceed.${NC}"
    echo -e "${YELLOW}If these are real secrets, remove them before committing!${NC}"
    read -p "Continue anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check for hardcoded localhost URLs in production code
if git diff --cached | grep -qE "http://localhost|http://127.0.0.1" | grep -v "example\|test\|spec"; then
    echo -e "${YELLOW}âš ï¸  WARNING: Found hardcoded localhost URLs${NC}"
    echo -e "${YELLOW}Consider using environment variables instead${NC}"
fi

# Check for console.log statements (warning only)
if git diff --cached --name-only | grep "\.jsx\?$\|\.tsx\?$" | xargs grep -nE "console\.(log|debug)" 2>/dev/null | grep -q .; then
    echo -e "${YELLOW}âš ï¸  WARNING: console.log statements found:${NC}"
    git diff --cached --name-only | grep "\.jsx\?$\|\.tsx\?$" | xargs grep -nE "console\.(log|debug)" 2>/dev/null
    echo -e "${YELLOW}Consider removing or replacing with proper logging${NC}"
fi

# Check for debugger statements
if git diff --cached | grep -qE "^\+.*debugger"; then
    echo -e "${RED}âŒ ERROR: debugger statement found!${NC}"
    echo -e "${YELLOW}Please remove debugger statements before committing${NC}"
    exit 1
fi

# Check for large files (> 1MB)
MAX_SIZE=1048576 # 1MB in bytes
for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        size=$(wc -c < "$file")
        if [ "$size" -gt "$MAX_SIZE" ]; then
            echo -e "${RED}âŒ ERROR: Large file detected: $file ($(($size / 1024))KB)${NC}"
            echo -e "${YELLOW}Files over 1MB should not be committed${NC}"
            echo -e "${YELLOW}Consider using Git LFS or hosting externally${NC}"
            exit 1
        fi
    fi
done

# Run npm audit if package.json changed
if git diff --cached --name-only | grep -q "package\.json$"; then
    echo -e "${GREEN}ðŸ“¦ Running npm audit...${NC}"
    if ! npm audit --audit-level=high; then
        echo -e "${RED}âŒ npm audit found high severity vulnerabilities${NC}"
        echo -e "${YELLOW}Run 'npm audit fix' to resolve them${NC}"
        exit 1
    fi
fi

# Check if .env.example is up to date
if [ -f ".env" ] && [ -f ".env.example" ]; then
    env_keys=$(grep -E "^[A-Z_]+=.*" .env | cut -d= -f1 | sort)
    example_keys=$(grep -E "^[A-Z_]+=.*" .env.example | cut -d= -f1 | sort)
    
    if [ "$env_keys" != "$example_keys" ]; then
        echo -e "${YELLOW}âš ï¸  WARNING: .env and .env.example have different keys${NC}"
        echo -e "${YELLOW}Please update .env.example to match .env structure${NC}"
    fi
fi

echo -e "${GREEN}âœ… Pre-commit checks passed!${NC}"
exit 0
